/*
* https://github.com/h-a-s-k/clewd-superfetch
*/
const{spawn:e,exec:s}=require("node:child_process");const{EventEmitter:t}=require("node:events");const r=require("ws");const{randomUUID:i}=require("node:crypto");const{relative:o,join:n,parse:a,resolve:c}=require("node:path");const{version:d}={version: '1.5.2'};class h extends t{constructor(e){super();this.version=d;this.role=e?.role||"server";this.port=e?.port||8443;this.host=e?.host||"localhost"}ws=void 0;process=void 0;port=void 0;host=void 0;requests={};binaries={win32:{x64:"clewd-superfetch-win-amd64.exe",ia32:"clewd-superfetch-win-ia32.exe"},darwin:{x64:"clewd-superfetch-mac-amd64",arm64:"clewd-superfetch-mac-arm64"},freebsd:{x64:"clewd-superfetch-freebsd-amd64",ia32:"clewd-superfetch-freebsd-ia32"},android:{arm64:"clewd-superfetch-android-arm64",arm:"clewd-superfetch-android-arm"},linux:{arm64:"clewd-superfetch-linux-arm64",arm:"clewd-superfetch-linux-arm",x64:"clewd-superfetch-linux-amd64",ia32:"clewd-superfetch-linux-ia32"}};get binary(){const e="win32"===process.platform;return`${e?'"':""}${c(__dirname,"./bin/"+this.binaries[process.platform][process.arch])}${e?'"':""}`}init(e){this.cleanProcs(true,(()=>{this.spawnGo((()=>{this.connectWS(e)}))}));this.on("error",(()=>{}))}findRequest(e){return this.requests[e]}modifyRequest(e,s,t){this.requests[e]||(this.requests[e]={});this.requests[e][t]=s}deleteRequest(e){delete this.requests[e]}connectWS(e){this.ws=new r(`ws://${this.host}:${this.port}`);this.ws.on("message",(e=>{const s=JSON.parse(e);const t=["Body","Headers","RequestID","Status"];Object.keys(s).every((e=>t.includes(e)));this.modifyRequest(s.RequestID,{body:s.Body,headers:s.Headers,requestId:s.RequestID,status:s.Status},"response");this.emit(s.RequestID,this.findRequest(s.RequestID))}));this.ws.on("connection",(()=>{}));this.ws.on("error",(e=>{console.warn("superfetch [[31merr[0m] %o",e)}));this.ws.on("open",(()=>{e&&e()}));this.ws.on("connection",(()=>{}))}async request(e){const s=["url","ja3","userAgent"].find((s=>!(s in e)));if(!e||s)throw Error(`Option ${s} is missing`);if(!e.ja3||!e.userAgent)throw Error("Options ja3 or userAgent are missing");e={url:e.url,method:e.method?.toLowerCase()||"get",headers:e.headers||{},Cookies:e.cookies||[{}],body:e.body||"",ja3:e.ja3,userAgent:e.userAgent,proxy:e.proxy||null,timeout:e.timeout||120,disableRedirect:e.disableRedirect||true,headerOrder:e.headerOrder||[]};const t=i();this.modifyRequest(t,{requestId:t,options:e},"request");this.ws.send(JSON.stringify(this.findRequest(t).request));const r=await this.awaitRequest(t);this.deleteRequest(t);return r}awaitRequest(e){return new Promise((s=>{this.on(e,(t=>{s(t);this.removeAllListeners(e)}))}))}spawnGo(s){console.log("superfetch [[2mload[0m] "+o(n(__dirname,"../../"),c(__dirname,this.binary.replace(/"/g,""))));this.process=e(this.binary,{env:{WS_HOST:this.host,WS_PORT:this.port},shell:true,windowsHide:true,killSignal:"SIGKILL",detached:"win32"!==process.platform});this.process.stderr.on("data",(e=>{if(e.toString().includes("Request_Id_On_The_Left")){const s=e.toString().split("Request_Id_On_The_Left");const[t,r]=s;console.warn("superfetch [[31merr[0m]",r)}else console.warn("superfetch [[31merr[0m]",e.toString())}));this.process.on("error",(e=>{this.emit("error",Error(e))}));this.process.on("spawn",(()=>{console.log(`superfetch v${this.version} [[32mspawn[0m]\n`);s&&setTimeout(s,1200)}))}cleanProcs(e=false,t){let r="win32"===process.platform?"taskkill /F /IM":"killall";const i=a(this.binary);const o=`${i.name}${i.ext}`;s(`${r} ${o}`,(()=>{t&&t()}))}exit(e){this.ws?.terminate();this.cleanProcs(false,e)}}module.exports=h;